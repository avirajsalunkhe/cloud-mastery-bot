<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Mastery Bot | Enrollment Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- React & ReactDOM (CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .active-tab { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden-tab { display: none; }
        .exam-card-selected { border-color: #3b82f6; background-color: #0f172a; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        [data-lucide] { width: 20px; height: 20px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans min-h-screen">
    <div id="root"></div>

    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 1. CONFIGURATION LOADING ---
        // This exact string is replaced by your GitHub Action Workflow
        const GITHUB_CONFIG_PLACEHOLDER = 'GITHUB_FIREBASE_CONFIG_PLACEHOLDER';
        let firebaseConfig = {};

        try {
            // Priority: Environment Variable (Preview) -> Injected Secret (GitHub) -> Fallback
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else if (GITHUB_CONFIG_PLACEHOLDER.startsWith('{')) {
                firebaseConfig = JSON.parse(GITHUB_CONFIG_PLACEHOLDER);
            }
        } catch (e) {
            console.error("Firebase config parsing failed.", e);
        }

        const APP_ID = 'cloud-devops-bot';

        const EXAM_PATHS = [
            { id: 'AZ-900', name: 'Azure Fundamentals', icon: 'globe', color: 'text-blue-400' },
            { id: 'AI-900', name: 'Azure AI Fundamentals', icon: 'cpu', color: 'text-purple-400' },
            { id: 'DP-900', name: 'Azure Data Fundamentals', icon: 'database', color: 'text-emerald-400' },
            { id: 'SC-900', name: 'Security Fundamentals', icon: 'shield', color: 'text-red-400' },
            { id: 'PL-900', name: 'Power Platform', icon: 'zap', color: 'text-pink-400' },
            { id: 'MS-900', name: 'Microsoft 365', icon: 'cloud', color: 'text-orange-400' },
        ];

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedExam, setSelectedExam] = useState('AZ-900');
            const [emailInput, setEmailInput] = useState('');
            const [lookupEmail, setLookupEmail] = useState('');
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [status, setStatus] = useState({ type: 'pending', text: 'Initializing...' });
            const [globalCount, setGlobalCount] = useState(0);
            const [userSubs, setUserSubs] = useState([]);
            const [isActionLoading, setIsActionLoading] = useState(false);

            useEffect(() => {
                if (!firebaseConfig.apiKey) {
                    setStatus({ type: 'error', text: 'Missing Configuration' });
                    return;
                }

                const firebaseApp = firebase.initializeApp(firebaseConfig);
                const firestore = firebaseApp.firestore();
                const auth = firebaseApp.auth();
                setDb(firestore);

                const initAuth = async () => {
                    try {
                        await auth.signInAnonymously();
                        auth.onAuthStateChanged((u) => {
                            setUser(u);
                            if (u) {
                                setStatus({ type: 'success', text: 'Live Connection' });
                                setupGlobalListener(firestore);
                            }
                        });
                    } catch (err) {
                        setStatus({ type: 'error', text: 'Connection Refused' });
                    }
                };

                initAuth();
                if (window.lucide) lucide.createIcons();
            }, []);

            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [activeTab, selectedExam, userSubs]);

            const setupGlobalListener = (firestore) => {
                const path = firestore.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('subscribers');
                path.onSnapshot((snap) => {
                    setGlobalCount(snap.size);
                }, (err) => {
                    console.error("Firestore Permission Error:", err);
                    setStatus({ type: 'error', text: 'Database Access Denied' });
                });
            };

            const handleSubscribe = async (e) => {
                e.preventDefault();
                if (!user || !db) return;
                setIsActionLoading(true);

                try {
                    const path = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('subscribers');
                    await path.add({
                        email: emailInput.toLowerCase().trim(),
                        examType: selectedExam,
                        subscribedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'active',
                        streak: 0,
                        userId: user.uid
                    });
                    alert(`Successfully enrolled in ${selectedExam}!`);
                    setEmailInput('');
                } catch (err) {
                    alert("Error enrolling. Check Firebase Rules.");
                } finally {
                    setIsActionLoading(false);
                }
            };

            const handleLookup = async (e) => {
                e.preventDefault();
                if (!user || !db) return;
                setIsActionLoading(true);

                try {
                    const path = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('subscribers');
                    const snap = await path.where('email', '==', lookupEmail.toLowerCase().trim()).get();
                    const results = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setUserSubs(results);
                } catch (err) {
                    alert("Search failed.");
                } finally {
                    setIsActionLoading(false);
                }
            };

            const handleUnsubscribe = async (id) => {
                if (!confirm("Are you sure?")) return;
                try {
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('subscribers').doc(id).delete();
                    setUserSubs(prev => prev.filter(s => s.id !== id));
                } catch (err) {
                    alert("Delete failed.");
                }
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    <header className="flex flex-col md:flex-row items-start md:items-center justify-between mb-12 gap-6 border-b border-slate-800 pb-6">
                        <div className="flex items-center gap-4">
                            <div className="bg-blue-600 p-3 rounded-2xl shadow-xl shadow-blue-500/20">
                                <i data-lucide="terminal" class="text-white"></i>
                            </div>
                            <div>
                                <h1 className="text-3xl font-black italic uppercase tracking-tighter">Cloud Mastery <span className="text-blue-500 not-italic">Bot</span></h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <div className={`w-2 h-2 rounded-full ${status.type === 'success' ? 'bg-emerald-500' : 'bg-blue-500 animate-pulse'}`}></div>
                                    <p className="text-slate-500 text-xs font-bold uppercase tracking-widest">{status.text}</p>
                                </div>
                            </div>
                        </div>
                        <div className="flex bg-slate-900/50 p-1 rounded-xl border border-slate-800 shadow-inner">
                            <button onClick={() => setActiveTab('dashboard')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'dashboard' ? 'active-tab' : 'text-slate-400'}`}>Enroll</button>
                            <button onClick={() => setActiveTab('manage')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'manage' ? 'active-tab' : 'text-slate-400'}`}>Manage</button>
                        </div>
                    </header>

                    {activeTab === 'dashboard' ? (
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className="lg:col-span-8 space-y-8">
                                <section>
                                    <h3 className="text-sm font-black text-slate-500 uppercase tracking-widest mb-4">Certification Tracks</h3>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                        {EXAM_PATHS.map((exam) => (
                                            <button 
                                                key={exam.id} 
                                                onClick={() => setSelectedExam(exam.id)}
                                                className={`p-5 rounded-2xl border-2 transition-all text-left bg-slate-950 ${selectedExam === exam.id ? 'exam-card-selected border-blue-500' : 'border-slate-800/50'}`}
                                            >
                                                <i data-lucide={exam.icon} className={`mb-3 ${exam.color}`}></i>
                                                <p className="text-xs font-black text-slate-300">{exam.id}</p>
                                            </button>
                                        ))}
                                    </div>
                                </section>
                                <section className="bg-slate-900/40 border border-slate-800 rounded-3xl p-8">
                                    <h2 className="text-xl font-black italic mb-6">Activate 5 Daily {selectedExam} Questions</h2>
                                    <form onSubmit={handleSubscribe} className="flex flex-col sm:flex-row gap-4">
                                        <input 
                                            type="email" 
                                            required 
                                            placeholder="Enter your email address..." 
                                            value={emailInput}
                                            onChange={(e) => setEmailInput(e.target.value)}
                                            className="flex-1 bg-slate-950 border border-slate-700 rounded-xl py-4 px-6 text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50" 
                                        />
                                        <button 
                                            type="submit" 
                                            disabled={isActionLoading}
                                            className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-xl font-black transition-all"
                                        >
                                            {isActionLoading ? 'Processing...' : 'Enroll Path'}
                                        </button>
                                    </form>
                                </section>
                            </div>
                            <div className="lg:col-span-4 space-y-6">
                                <div className="bg-blue-600 rounded-3xl p-8 shadow-2xl">
                                    <p className="text-blue-100 text-xs font-bold uppercase mb-2">Network</p>
                                    <h3 className="text-5xl font-black text-white">{globalCount}</h3>
                                    <p className="text-blue-200 text-[10px] mt-2 font-bold uppercase tracking-widest opacity-80">Active Learners Today</p>
                                </div>
                                <a href="https://buymeacoffee.com/avirajsalunkhe" target="_blank" className="w-full block text-center bg-amber-500 hover:bg-amber-400 text-slate-950 font-black py-4 rounded-2xl text-xs shadow-lg shadow-amber-500/10">Buy me a coffee</a>
                            </div>
                        </div>
                    ) : (
                        <div className="max-w-2xl mx-auto space-y-8">
                            <form onSubmit={handleLookup} className="flex gap-4">
                                <input 
                                    type="email" 
                                    required 
                                    placeholder="Enter email to lookup..." 
                                    value={lookupEmail}
                                    onChange={(e) => setLookupEmail(e.target.value)}
                                    className="flex-1 bg-slate-900 border border-slate-800 rounded-xl py-4 px-6 outline-none"
                                />
                                <button type="submit" className="bg-slate-800 px-8 rounded-xl font-bold">Search</button>
                            </form>
                            <div className="space-y-4">
                                {userSubs.map(sub => (
                                    <div key={sub.id} className="bg-slate-950 p-6 rounded-2xl border border-slate-800 flex justify-between items-center">
                                        <div>
                                            <h4 className="font-black text-blue-400 uppercase text-xs">{sub.examType} Path</h4>
                                            <p className="text-lg font-bold">Streak: {sub.streak || 0} Days</p>
                                        </div>
                                        <button onClick={() => handleUnsubscribe(sub.id)} className="text-slate-500 hover:text-red-400 transition-all font-bold text-xs uppercase"><i data-lucide="user-minus" className="inline-block mr-1"></i> Delete</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
